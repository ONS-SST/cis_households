stages:
  - function: delete_tables
    run: False
    table_names:
    pattern:
    prefix:

  - function: historical_blood_ETL
    run: False
    resource_path: "hdfs:///ons/covserolink/landing_zone/historical_bloods/historical_bloods_*.csv"
    include_invalid: True
    include_processed: True

  - function: blood_delta_ETL
    run: False
    resource_path: "hdfs:///ons/covserolink/landing_zone/bloods/Unioxf_medtest*.csv"
    include_invalid: True
    include_processed: True

  - function: swab_delta_ETL
    run: False
    resource_path: "hdfs:///ons/covserolink/landing_zone/swabs/ONS_GL_Report_*.csv"
    include_invalid: True
    include_processed: True

  - function: survey_responses_version_0_ETL
    run: False
    resource_path: "hdfs:///ons/covserolink/landing_zone/responses_v0/ONS_Datafile_*.csv"
    latest_only: True
    include_invalid: True
    include_processed: True
    end_date: 2028-12-31

  - function: survey_responses_version_1_ETL
    run: False
    resource_path: "hdfs:///ons/covserolink/landing_zone/responses_v1/ONSECRF4_Datafile_*.csv"
    latest_only: True
    include_invalid: True
    include_processed: True
    end_date: 2028-12-31

  - function: survey_responses_version_2_ETL
    run: False
    resource_path: "hdfs:///ons/covserolink/landing_zone/responses_v2/ONSECRF5_Datafile_*.csv"
    latest_only: True
    include_invalid: True
    include_processed: True
    end_date: 2028-12-31

  - function: union_survey_response_files
    run: False
    unioned_survey_table: unioned_survey_responses
    transformed_survey_table: transformed_survey_responses_v*_data

  - function: union_dependent_transformations
    run: False
    unioned_survey_table: unioned_survey_responses

  - function: validate_survey_responses
    run: False
    unioned_survey_table: unioned_survey_responses
    valid_survey_table: validated_survey_responses
    invalid_survey_table: erroneous_survey_responses


  - function: outer_join_blood_results
    run: False
    blood_table: transformed_blood_test_data
    antibody_table: joined_blood_test_data
    failed_blood: failed_blood_test_join


  - function: merge_blood_ETL
    run: False
    antibody_table: joined_blood_test_data
    unioned_survey_table: unioned_survey_responses
    antibody_output_tables: [
      "merged_responses_antibody_data",
      "antibody_merge_residuals",
      "antibody_merge_failed_records",
    ]


  - function: merge_swab_ETL
    run: False
    swab_table: transformed_swab_test_data
    unioned_survey_table: unioned_survey_responses
    swab_output_tables: [
      "merged_responses_antibody_swab_data",
      "swab_merge_residuals",
      "swab_merge_failed_records",
    ]

  - funciton: join_vaccination_data
    run: False
    nims_table:
    participant_records_table: participant_level_key_records
    vaccination_data_table: participant_level_with_vaccination_data


  - function: process_post_merge
    run: False
    merged_antibody_swab: merged_responses_antibody_swab_data
    imputed_values_table: imputed_value_lookup
    participant_records_table: participant_level_key_records
    response_records_table: response_level_records
    invalid_response_records_table: invalid_response_records_future


  - function: generate_outputs
    run: False

  - function: tables_to_csv
    run: False
    table_file_pairs:
      - [unioned_survey_responses, unioned_survey_responses]

storage:
    database: covserolink_dev
    table_prefix: USERNAME_
    write_mode: append

pyspark_session_size: m
